<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Interactive Protein UMAP Plot</title>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    display: flex;
    height: 100vh;
    overflow: hidden;
}

/* Panels */
#left-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #ddd;
    padding: 15px;
    box-sizing: border-box;
    overflow-y: auto;
    min-width: 250px;
}

#right-panel {
    flex: 2;
    display: flex;
    flex-direction: column;
    padding: 15px;
    box-sizing: border-box;
    overflow: hidden;
}

/* Search and Controls */
#search-container {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}

#search-input {
    flex: 1 1 auto;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    min-width: 140px;
}

#search-container button {
    padding: 8px 15px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    flex: 0 0 auto;
}

#search-container button:hover {
    background-color: #0056b3;
}

#options-container label {
    display: block;
    margin-top: 5px;
    cursor: pointer;
}

#reset-btn {
    margin-top: 10px;
    align-self: flex-end;
    padding: 8px 15px;
    background-color: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

#reset-btn:hover {
    background-color: #a71d2a;
}

/* Protein list */
#protein-list {
    list-style: none;
    padding: 0;
    margin: 0 0 10px 0;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.protein-list-item {
    padding: 5px;
    margin: 0;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}

.protein-list-item:last-child {
    border-bottom: none;
}

.protein-list-item:hover {
    background-color: #e0e0e0;
}

.protein-list-item.active {
    background-color: #d0e0ff;
    font-weight: bold;
}

/* Plot + sequences */
#plot-container {
    flex-grow: 1;
    min-height: 300px;
}

.sequence-container {
    background-color: #e9ecef;
    border: 1px solid #ced4da;
    padding: 10px;
    border-radius: 5px;
    font-family: 'Courier New', monospace;
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 200px;
    overflow-y: auto;
    margin-top: 5px;
}

#size-slider-container {
    margin: 10px 0;
}

h3 { margin-top: 0; }

/* -------- Responsive Breakpoints -------- */
@media (max-width: 1024px) {
    body {
        flex-direction: column;
        height: auto;
        overflow: auto;
    }

    #left-panel, #right-panel {
        flex: none;
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 1px solid #ddd;
    }

    #reset-btn {
        align-self: flex-start;
    }
}

@media (max-width: 600px) {
    #search-container {
        flex-direction: column;
        gap: 5px;
    }

    #search-container button {
        width: 100%;
    }

    #protein-list {
        max-height: 150px;
    }

    .sequence-container {
        max-height: 150px;
    }
    
    #plot-container {
        margin-left: 20%;
        margin-right: 20%;
    }
}

</style>
</head>
<body>

<div id="left-panel">
    <div id="search-container">
        <input type="text" id="search-input" placeholder="Search protein label..." />
        <button onclick="searchProtein()">Search</button>
    </div>

    <div id="options-container">
        <label><input type="checkbox" id="highlight-nearest" onchange="updatePlotVisibility()"> Highlight 5 nearest proteins</label>
        <label><input type="checkbox" id="hide-others" onchange="updatePlotVisibility()"> Hide unhighlighted proteins</label>
    </div>

    <!-- Slider -->
    <div id="size-slider-container">
        <label for="point-size-slider">Point Size:</label>
        <input type="range" id="point-size-slider" min="1" max="10" step="1" value="2" oninput="updatePointSize(this.value)">
        <span id="point-size-value">2</span>
    </div>
    
    <h3>Protein Labels</h3>
    <ul id="protein-list"></ul>

    <button id="reset-btn" onclick="resetSelection()">Reset</button>

    <h3>Selected Protein Details</h3>
    <div id="protein-info">
        <p>Click a protein label or search to see its details here.</p>
    </div>
</div>

<div id="right-panel">
    <div id="plot-container"></div>
</div>

<script>
let umap_data;
let selectedIndex = -1;
let nearest5Cache = [];
let basePointSize = 2;
let hasBeenClicked = false; 

const plotContainer = document.getElementById('plot-container');
const proteinInfoDiv = document.getElementById('protein-info');
const proteinList = document.getElementById('protein-list');

async function plotUmap() {
    const response = await fetch('/data');
    umap_data = await response.json();
    populateLabelList();

    const trace = {
        x: umap_data.x,
        y: umap_data.y,
        z: umap_data.z,
        mode: 'markers',
        type: 'scatter3d',
        marker: { size: basePointSize, opacity: 0.7, color: 'blue' },
        text: umap_data.hover,
        hoverinfo: 'text'
    };

    const layout = {
        title: 'UMAP (3D)',
        scene: { xaxis: { title: 'UMAP-1' }, yaxis: { title: 'UMAP-2' }, zaxis: { title: 'UMAP-3' } },
        margin: { l: 0, r: 0, b: 0, t: 60 }
    };

    Plotly.newPlot(plotContainer, [trace], layout);
     plotContainer.on('plotly_click', function(data) {
        if (hasBeenClicked) {
            return; // Ignore subsequent clicks
        }

        if (data.points && data.points.length > 0) {
            hasBeenClicked = true;
            const clickedPointText = data.points[0].text;
            const index = umap_data.label.findIndex(label => label === clickedPointText);
            
            if (index !== -1) {
                highlightProtein(index);
            }
        }
    });

}

function populateLabelList() {
    proteinList.innerHTML = '';
    umap_data.label.forEach((label, index) => {
        const li = document.createElement('li');
        li.textContent = label;
        li.classList.add('protein-list-item');
        li.setAttribute('data-index', index);
        li.addEventListener('click', () => { highlightProtein(index); });
        proteinList.appendChild(li);
    });
}

function updatePlotVisibility() {
    if (selectedIndex === -1) return;

    const highlightNearest = document.getElementById('highlight-nearest').checked;
    const hideOthers = document.getElementById('hide-others').checked;

    const sizes = Array(umap_data.x.length).fill(basePointSize);
    const colors = Array(umap_data.x.length).fill('black');

    sizes[selectedIndex] = basePointSize * 10;
    colors[selectedIndex] = 'red';

    let nearest5 = [];
    if (highlightNearest) {
        nearest5 = nearest5Cache;
        nearest5.forEach(d => { sizes[d.index] = basePointSize * 5; colors[d.index] = 'green'; });
    }

    if (hideOthers) {
        for (let i = 0; i < umap_data.x.length; i++) {
            if (i !== selectedIndex && !nearest5.some(d => d.index === i)) {
                sizes[i] = 0;
                colors[i] = 'rgba(0,0,0,0)';
            }
        }
    }

    Plotly.restyle(plotContainer, { 'marker.size': [sizes], 'marker.color': [colors] }, [0]);
    renderProteinInfo(selectedIndex, highlightNearest);
}

function highlightProtein(index) {
    selectedIndex = index;

    document.querySelectorAll('.protein-list-item').forEach(item => item.classList.remove('active'));
    const li = document.querySelector(`.protein-list-item[data-index='${index}']`);
    if (li) li.classList.add('active');

    // compute nearest 5
    const x = umap_data.x[index], y = umap_data.y[index], z = umap_data.z[index];
    const distances = [];
    for (let i = 0; i < umap_data.x.length; i++) {
        if (i === index) continue;
        const dx = umap_data.x[i] - x, dy = umap_data.y[i] - y, dz = umap_data.z[i] - z;
        const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
        distances.push({ index: i, dist });
    }
    distances.sort((a, b) => a.dist - b.dist);
    nearest5Cache = distances.slice(0, 5);

    updatePlotVisibility();
}

function renderProteinInfo(index, showNearest) {
    const x = umap_data.x[index];
    const y = umap_data.y[index];
    const z = umap_data.z[index];
    const sequence = umap_data.sequence[index] || 'Sequence not available.';

    let nearestHtml = '';
    if (showNearest) {
        nearestHtml = '<p><strong>Nearest 5 Proteins:</strong></p><ul>';
        nearest5Cache.forEach(d => {
            nearestHtml += `<li>${umap_data.label[d.index]} (distance: ${d.dist.toFixed(2)})</li>`;
        });
        nearestHtml += '</ul>';

        nearestHtml += '<p><strong>Nearest Sequences:</strong></p>';
        nearest5Cache.forEach(d => {
            const seq = umap_data.sequence[d.index] || 'Sequence not available.';
            nearestHtml += `<div class="sequence-container"><strong>${umap_data.label[d.index]}:</strong><br>${seq}</div>`;
        });
    }

    proteinInfoDiv.innerHTML = `
        <p><strong>Label:</strong> ${umap_data.label[index]}</p>
        <p><strong>Coordinates:</strong> (${x.toFixed(2)}, ${y.toFixed(2)}, ${z.toFixed(2)})</p>
        <p><strong>Hover Info:</strong> ${umap_data.hover[index]}</p>
        <p><strong>Sequence:</strong></p>
        <div class="sequence-container">${sequence}</div>
        ${nearestHtml}
    `;
}

function searchProtein() {
    const query = document.getElementById('search-input').value.trim();
    const index = umap_data.label.findIndex(l => l.includes(query));
    if (index !== -1) {
        highlightProtein(index);
        const li = document.querySelector(`.protein-list-item[data-index='${index}']`);
        if (li) li.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

function resetSelection() {
    selectedIndex = -1;
    nearest5Cache = [];

    hasBeenClicked=false;
    // Reset plot to all blue points
    const sizes = Array(umap_data.x.length).fill(basePointSize);
    const colors = Array(umap_data.x.length).fill('blue');
    Plotly.restyle(plotContainer, { 'marker.size': [sizes], 'marker.color': [colors] }, [0]);

    // Clear active highlight in list
    document.querySelectorAll('.protein-list-item').forEach(item => item.classList.remove('active'));

    // Reset protein info panel
    proteinInfoDiv.innerHTML = `<p>Click a protein label or search to see its details here.</p>`;
}

function updatePointSize(value) {
    basePointSize = parseInt(value);
    document.getElementById('point-size-value').textContent = value;
    if (selectedIndex === -1) {
        const sizes = Array(umap_data.x.length).fill(basePointSize);
        Plotly.restyle(plotContainer, { 'marker.size': [sizes] }, [0]);
    } else {
        updatePlotVisibility();
    }
}


plotUmap();
</script>
</body>
</html>
